import streamlit as st
import os
from dotenv import load_dotenv
from openai import OpenAI

# ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
load_dotenv()

# OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(
    page_title="AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ",
    page_icon="ğŸ¤–",
    layout="centered"
)

# ã‚¿ã‚¤ãƒˆãƒ«
st.title("ğŸ¤– AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ")

# ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ–
if "messages" not in st.session_state:
    st.session_state.messages = []

# ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è¡¨ç¤º
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
if prompt := st.chat_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."):
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å±¥æ­´ã«è¿½åŠ 
    st.session_state.messages.append({"role": "user", "content": prompt})
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    with st.chat_message("user"):
        st.markdown(prompt)
    
    # AIã®å¿œç­”ã‚’ç”Ÿæˆ
    with st.chat_message("assistant"):
        with st.spinner("è€ƒãˆä¸­..."):
            try:
                response = client.chat.completions.create(
                    model="gpt-3.5-turbo",
                    messages=[
                        {"role": "system", "content": "ã‚ãªãŸã¯è¦ªåˆ‡ã§æœ‰ç”¨ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æ—¥æœ¬èªã§ä¸å¯§ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚"},
                        *st.session_state.messages
                    ],
                    max_tokens=1000,
                    temperature=0.7
                )
                
                ai_response = response.choices[0].message.content
                st.markdown(ai_response)
                
                # AIã®å¿œç­”ã‚’å±¥æ­´ã«è¿½åŠ 
                st.session_state.messages.append({"role": "assistant", "content": ai_response})
                
            except Exception as e:
                st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                st.info("OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")

# ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³
with st.sidebar:
    st.header("âš™ï¸ è¨­å®š")
    
    # ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ã‚¯ãƒªã‚¢
    if st.button("ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢"):
        st.session_state.messages = []
        st.rerun()
    
    # ä½¿ç”¨æ–¹æ³•ã®èª¬æ˜
    st.header("ğŸ“– ä½¿ç”¨æ–¹æ³•")
    st.markdown("""
    1. `.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦OpenAI APIã‚­ãƒ¼ã‚’è¨­å®š
    2. ä¸‹ã®ãƒãƒ£ãƒƒãƒˆå…¥åŠ›æ¬„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›
    3. Enterã‚’æŠ¼ã—ã¦AIã¨ä¼šè©±é–‹å§‹
    """)
    
    st.header("ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—")
    st.code("""
    # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    pip install -r requirements.txt
    
    # ã‚¢ãƒ—ãƒªã®å®Ÿè¡Œ
    streamlit run app.py
    """)